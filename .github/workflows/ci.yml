name: Python OpenCV CI (Headless)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install minimal system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            pytest \
            opencv-python-headless \
            numpy \
            pillow \
            matplotlib

      - name: Setup test environment
        run: |
          mkdir -p input output test_output
          
          # Create a simple test image programmatically if input is empty
          if [ ! -f "input/test.jpg" ]; then
            python -c "
import numpy as np
from PIL import Image
arr = np.random.randint(0, 255, (100, 100, 3), dtype=np.uint8)
img = Image.fromarray(arr)
img.save('input/test.jpg')
print('Created test image')
"

      - name: Run tests
        run: |
          # Run tests
          python -m pytest -v --tb=short -x

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_output/
            input/
          retention-days: 5
